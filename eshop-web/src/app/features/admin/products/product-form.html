<div class="product-form-container">
  <div class="page-header">
    <h1>{{ isEditMode() ? 'Edit Product' : 'Add New Product' }}</h1>
    <p class="subtitle">{{ isEditMode() ? 'Update product information' : 'Create a new catalog item' }}</p>
  </div>

  <mat-card class="form-card">
    <mat-card-content>
      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Product Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Product Name</mat-label>
            <input matInput formControlName="name" placeholder="Enter product name" />
            <mat-icon matPrefix>inventory_2</mat-icon>
            @if (productForm.get('name')?.hasError('required') && productForm.get('name')?.touched) {
              <mat-error>Product name is required</mat-error>
            }
            @if (productForm.get('name')?.hasError('minlength')) {
              <mat-error>Name must be at least 3 characters</mat-error>
            }
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="4" placeholder="Enter product description"></textarea>
            <mat-icon matPrefix>description</mat-icon>
            @if (productForm.get('description')?.hasError('required') && productForm.get('description')?.touched) {
              <mat-error>Description is required</mat-error>
            }
          </mat-form-field>

          <!-- Price -->
          <mat-form-field appearance="outline">
            <mat-label>Price</mat-label>
            <input matInput type="number" formControlName="price" placeholder="0.00" step="0.01" />
            <span matPrefix>$&nbsp;</span>
            @if (productForm.get('price')?.hasError('required') && productForm.get('price')?.touched) {
              <mat-error>Price is required</mat-error>
            }
            @if (productForm.get('price')?.hasError('min')) {
              <mat-error>Price must be positive</mat-error>
            }
          </mat-form-field>

          <!-- Image Upload Section -->
          <div class="image-upload-section full-width">
            <h3 class="section-title">Product Image</h3>

            <div class="image-upload-content">
              <!-- Image Preview -->
              <div class="image-preview-container">
                @if (imagePreview() || productForm.get('pictureFileName')?.value) {
                  <div class="image-preview">
                    <img
                      [src]="imagePreview() || getImageUrl(productForm.get('pictureFileName')?.value)"
                      alt="Product preview"
                    />
                    <button
                      mat-icon-button
                      class="remove-image-btn"
                      type="button"
                      (click)="removeImage()"
                      [disabled]="uploadingImage()"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                } @else {
                  <div class="image-placeholder">
                    <mat-icon>add_photo_alternate</mat-icon>
                    <p>No image selected</p>
                  </div>
                }
              </div>

              <!-- Upload Controls -->
              <div class="upload-controls">
                <input
                  type="file"
                  #fileInput
                  (change)="onFileSelected($event)"
                  accept="image/*"
                  style="display: none"
                />

                <button
                  mat-raised-button
                  type="button"
                  (click)="fileInput.click()"
                  [disabled]="uploadingImage()"
                >
                  <mat-icon>photo_camera</mat-icon>
                  Choose Image
                </button>

                @if (selectedFile && !productForm.get('pictureFileName')?.value) {
                  @if (uploadingImage()) {
                    <button
                      mat-raised-button
                      color="primary"
                      type="button"
                      [disabled]="true"
                    >
                      <mat-icon>hourglass_empty</mat-icon>
                      Uploading...
                    </button>
                  } @else {
                    <button
                      mat-raised-button
                      color="primary"
                      type="button"
                      (click)="uploadImage()"
                    >
                      <mat-icon>cloud_upload</mat-icon>
                      Upload Image
                    </button>
                  }
                }

                @if (productForm.get('pictureFileName')?.value) {
                  <div class="upload-success">
                    <mat-icon>check_circle</mat-icon>
                    <span>Image uploaded successfully</span>
                  </div>
                }
              </div>

              <p class="upload-hint">
                Accepted formats: JPG, PNG, GIF, WEBP (Max 5MB)
              </p>

              <!-- Hidden field for form validation -->
              <input type="hidden" formControlName="pictureFileName" />
            </div>
          </div>

          <!-- Brand -->
          <mat-form-field appearance="outline">
            <mat-label>Brand</mat-label>
            <mat-select formControlName="catalogBrandId">
              @for (brand of brands(); track brand.id) {
                <mat-option [value]="brand.id">{{ brand.brand }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>label</mat-icon>
            @if (productForm.get('catalogBrandId')?.hasError('required') && productForm.get('catalogBrandId')?.touched) {
              <mat-error>Brand is required</mat-error>
            }
          </mat-form-field>

          <!-- Type -->
          <mat-form-field appearance="outline">
            <mat-label>Type</mat-label>
            <mat-select formControlName="catalogTypeId">
              @for (type of types(); track type.id) {
                <mat-option [value]="type.id">{{ type.type }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
            @if (productForm.get('catalogTypeId')?.hasError('required') && productForm.get('catalogTypeId')?.touched) {
              <mat-error>Type is required</mat-error>
            }
          </mat-form-field>

          <!-- Available Stock -->
          <mat-form-field appearance="outline">
            <mat-label>Available Stock</mat-label>
            <input matInput type="number" formControlName="availableStock" placeholder="0" />
            <mat-icon matPrefix>inventory</mat-icon>
            @if (productForm.get('availableStock')?.hasError('required') && productForm.get('availableStock')?.touched) {
              <mat-error>Stock is required</mat-error>
            }
          </mat-form-field>

          <!-- Restock Threshold -->
          <mat-form-field appearance="outline">
            <mat-label>Restock Threshold</mat-label>
            <input matInput type="number" formControlName="restockThreshold" placeholder="5" />
            <mat-icon matPrefix>notifications</mat-icon>
          </mat-form-field>

          <!-- Max Stock Threshold -->
          <mat-form-field appearance="outline">
            <mat-label>Max Stock Threshold</mat-label>
            <input matInput type="number" formControlName="maxStockThreshold" placeholder="100" />
            <mat-icon matPrefix>storefront</mat-icon>
          </mat-form-field>
        </div>

        <!-- Specifications Section -->
        <div class="specifications-section full-width">
          <h3 class="section-title">
            <mat-icon>view_list</mat-icon>
            Technical Specifications
            <span class="spec-count">({{ specifications().length }} items)</span>
          </h3>

          <!-- Add New Specification -->
          <div class="add-specification">
            <mat-form-field appearance="outline" class="spec-key-input">
              <mat-label>Specification Key</mat-label>
              <input
                matInput
                [value]="newSpecKey()"
                (input)="newSpecKey.set($any($event.target).value)"
                placeholder="e.g., RAM, Couleur, Taille"
              />
              <mat-icon matPrefix>label</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="spec-value-input">
              <mat-label>Value</mat-label>
              <input
                matInput
                [value]="newSpecValue()"
                (input)="newSpecValue.set($any($event.target).value)"
                placeholder="e.g., 8GB, Bleu, M"
                (keyup.enter)="addSpecification()"
              />
              <mat-icon matPrefix>text_fields</mat-icon>
            </mat-form-field>

            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="addSpecification()"
              [disabled]="!newSpecKey() || !newSpecValue()"
            >
              <mat-icon>add</mat-icon>
              Add Spec
            </button>
          </div>

          <!-- Specifications List -->
          @if (specifications().length > 0) {
            <div class="specifications-list">
              @for (spec of specifications(); track $index) {
                <div class="specification-item">
                  <mat-form-field appearance="outline" class="spec-key">
                    <mat-label>Key</mat-label>
                    <input
                      matInput
                      [value]="spec.key"
                      (input)="updateSpecificationKey($index, $any($event.target).value)"
                    />
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="spec-value">
                    <mat-label>Value</mat-label>
                    <input
                      matInput
                      [value]="spec.value"
                      (input)="updateSpecificationValue($index, $any($event.target).value)"
                    />
                  </mat-form-field>

                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeSpecification($index)"
                    class="remove-spec-btn"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="no-specifications">
              <mat-icon>info</mat-icon>
              <p>No specifications added yet. Add key-value pairs above.</p>
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-raised-button type="button" (click)="cancel()">
            <mat-icon>cancel</mat-icon>
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading() || productForm.invalid">
            <mat-icon>{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
            {{ isEditMode() ? 'Update Product' : 'Create Product' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
