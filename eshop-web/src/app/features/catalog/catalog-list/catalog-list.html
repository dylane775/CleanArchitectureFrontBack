<!-- Breadcrumb Navigation -->
<app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

<div class="catalog-wrapper">
  <!-- Filters Section (Left Side) -->
  <aside class="filters-section">
    <div class="filters-header">
      <h2>Filters</h2>
      @if (getActiveFiltersCount() > 0) {
        <button mat-button (click)="clearAllFilters()" class="clear-all-btn">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      }
    </div>

    <!-- Price Range Filter -->
    <div class="filter-group">
      <h3 class="filter-title">
        <mat-icon>payments</mat-icon>
        Price Range
      </h3>
      <div class="price-filter-content">
        <div class="price-values">
          <span class="price-label">{{ formatPrice(priceMin) }}</span>
          <span class="price-separator">-</span>
          <span class="price-label">{{ formatPrice(priceMax) }}</span>
        </div>
        <mat-slider [min]="0" [max]="maxPrice" [step]="10" class="price-slider">
          <input matSliderStartThumb [(ngModel)]="priceMin" (ngModelChange)="onPriceChange()">
          <input matSliderEndThumb [(ngModel)]="priceMax" (ngModelChange)="onPriceChange()">
        </mat-slider>
      </div>
    </div>

    <!-- Categories Filter -->
    <div class="filter-group">
      <h3 class="filter-title">
        <mat-icon>category</mat-icon>
        Categories
      </h3>
      <div class="filter-options">
        @for (category of categories(); track category.value) {
          <mat-checkbox
            [(ngModel)]="category.checked"
            (change)="applyFilters()"
            class="filter-checkbox">
            <span class="filter-label">{{ category.label }}</span>
            @if (category.count) {
              <span class="filter-count">({{ category.count }})</span>
            }
          </mat-checkbox>
        }
      </div>
    </div>

    <!-- Brands Filter -->
    <div class="filter-group">
      <h3 class="filter-title">
        <mat-icon>local_offer</mat-icon>
        Brands
      </h3>
      <div class="filter-options">
        @for (brand of brands(); track brand.value) {
          <mat-checkbox
            [(ngModel)]="brand.checked"
            (change)="applyFilters()"
            class="filter-checkbox">
            <span class="filter-label">{{ brand.label }}</span>
            @if (brand.count) {
              <span class="filter-count">({{ brand.count }})</span>
            }
          </mat-checkbox>
        }
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="catalog-main">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    } @else {
      <!-- Toolbar with Results Count and Sort -->
      <div class="catalog-toolbar">
        <div class="results-info">
          <h1 class="results-title">
            @if (searchQuery()) {
              Results for "{{ searchQuery() }}"
            } @else {
              All Products
            }
          </h1>
          <p class="results-count">
            <span class="count-number">{{ totalItems() }}</span>
            {{ totalItems() === 1 ? 'result' : 'results' }}
          </p>
        </div>

        <div class="sort-section">
          <label class="sort-label">Sort by:</label>
          <mat-chip-listbox [value]="sortBy()" (change)="onSortChange($event)" class="sort-chips" aria-label="Sort options">
            <mat-chip-option value="featured">Featured</mat-chip-option>
            <mat-chip-option value="price-asc">Price: Low to High</mat-chip-option>
            <mat-chip-option value="price-desc">Price: High to Low</mat-chip-option>
            <mat-chip-option value="newest">Newest Arrivals</mat-chip-option>
          </mat-chip-listbox>
        </div>
      </div>

      <!-- Active Filters Chips -->
      @if (getActiveFiltersCount() > 0) {
        <div class="active-filters">
          <mat-chip-set class="filter-chips">
            @for (category of categories(); track category.value) {
              @if (category.checked) {
                <mat-chip (removed)="category.checked = false; applyFilters()">
                  {{ category.label }}
                  <button matChipRemove aria-label="Remove filter">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              }
            }
            @for (brand of brands(); track brand.value) {
              @if (brand.checked) {
                <mat-chip (removed)="brand.checked = false; applyFilters()">
                  {{ brand.label }}
                  <button matChipRemove aria-label="Remove filter">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              }
            }
            @if (priceRange()[0] !== 0 || priceRange()[1] !== maxPrice) {
              <mat-chip (removed)="resetPriceFilter()">
                {{ formatPrice(priceRange()[0]) }} - {{ formatPrice(priceRange()[1]) }}
                <button matChipRemove aria-label="Remove price filter">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        </div>
      }

      <!-- Category Sections with Horizontal Carousels -->
      @if (categorySections().length > 0) {
        <div class="category-sections">
          @for (section of categorySections(); track section.category.value) {
            <section class="category-section">
              <div class="section-header">
                <h2 class="section-title">
                  <mat-icon>category</mat-icon>
                  {{ section.category.label }}
                </h2>
                <span class="section-count">{{ section.items.length }} {{ section.items.length === 1 ? 'item' : 'items' }}</span>
              </div>

              <div class="carousel-container">
                <div class="carousel-track" [class.auto-scroll]="section.items.length >= 5">
                  @for (item of section.items; track item.id + '-1') {
                    <div class="carousel-item">
                      <app-catalog-item
                        [item]="item"
                        [compact]="true"
                        (addToBasket)="onAddToBasket($event)">
                      </app-catalog-item>
                    </div>
                  }
                  <!-- Duplicate items for seamless loop (only if >= 5 items) -->
                  @if (section.items.length >= 5) {
                    @for (item of section.items; track item.id + '-2') {
                      <div class="carousel-item">
                        <app-catalog-item
                          [item]="item"
                          [compact]="true"
                          (addToBasket)="onAddToBasket($event)">
                        </app-catalog-item>
                      </div>
                    }
                  }
                </div>
              </div>
            </section>
          }
        </div>
      }

      <!-- All Products Grid -->
      @if (paginatedItems().length > 0) {
        <section class="all-products-section">
          <div class="section-header">
            <h2 class="section-title">
              <mat-icon>apps</mat-icon>
              All Results
            </h2>
          </div>

          <div class="products-grid">
            @for (item of paginatedItems(); track item.id) {
              <app-catalog-item
                [item]="item"
                (addToBasket)="onAddToBasket($event)">
              </app-catalog-item>
            }
          </div>

          <!-- Pagination -->
          @if (totalItems() > pageSize) {
            <mat-paginator
              [length]="totalItems()"
              [pageSize]="pageSize"
              [pageIndex]="pageIndex"
              [pageSizeOptions]="[12, 24, 48, 96]"
              (page)="onPageChange($event)"
              aria-label="Select page"
              class="products-paginator">
            </mat-paginator>
          }
        </section>
      } @else {
        <div class="no-results">
          <mat-icon>search_off</mat-icon>
          <h3>No products found</h3>
          <p>Try adjusting your filters or search query</p>
          <button mat-raised-button color="primary" (click)="clearAllFilters()">
            Clear All Filters
          </button>
        </div>
      }
    }
  </main>
</div>
