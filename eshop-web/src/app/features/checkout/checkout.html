<div class="checkout-container">
  <h1 class="checkout-title">Checkout</h1>

  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  } @else {
    <mat-stepper linear #stepper>
      <!-- Step 1: Shipping Information -->
      <mat-step [stepControl]="shippingFormGroup" label="Shipping Information">
        <form [formGroup]="shippingFormGroup" class="checkout-form">
          <h2>Contact Information</h2>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>First Name</mat-label>
              <input matInput formControlName="firstName" required>
              <mat-error>First name is required</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="lastName" required>
              <mat-error>Last name is required</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email" required>
              <mat-icon matPrefix>email</mat-icon>
              <mat-error>Valid email is required</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Phone (Optional)</mat-label>
              <input matInput type="tel" formControlName="phone">
              <mat-icon matPrefix>phone</mat-icon>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <h2>Shipping Address</h2>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="shippingStreet" required>
            <mat-icon matPrefix>home</mat-icon>
            <mat-error>Street address is required</mat-error>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>City</mat-label>
              <input matInput formControlName="shippingCity" required>
              <mat-error>City is required</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>State/Province</mat-label>
              <input matInput formControlName="shippingState" required>
              <mat-error>State is required</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>ZIP/Postal Code</mat-label>
              <input matInput formControlName="shippingZipCode" required>
              <mat-error>ZIP code is required</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Country</mat-label>
              <input matInput formControlName="shippingCountry" required>
              <mat-error>Country is required</mat-error>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <h2>Billing Address</h2>
          <mat-checkbox formControlName="sameAsBilling" class="same-as-billing">
            Same as shipping address
          </mat-checkbox>

          @if (!shippingFormGroup.get('sameAsBilling')?.value) {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Billing Street Address</mat-label>
              <input matInput formControlName="billingStreet">
              <mat-icon matPrefix>home</mat-icon>
              <mat-error>Billing street address is required</mat-error>
            </mat-form-field>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Billing City</mat-label>
                <input matInput formControlName="billingCity">
                <mat-error>Billing city is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Billing State/Province</mat-label>
                <input matInput formControlName="billingState">
                <mat-error>Billing state is required</mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Billing ZIP/Postal Code</mat-label>
                <input matInput formControlName="billingZipCode">
                <mat-error>Billing ZIP code is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Billing Country</mat-label>
                <input matInput formControlName="billingCountry">
                <mat-error>Billing country is required</mat-error>
              </mat-form-field>
            </div>
          }

          <div class="step-actions">
            <button mat-raised-button color="primary" matStepperNext>
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Payment Method -->
      <mat-step [stepControl]="paymentFormGroup" label="Payment">
        <form [formGroup]="paymentFormGroup" class="checkout-form">
          <h2>Payment Method</h2>

          <mat-radio-group formControlName="paymentMethod" class="payment-methods">
            @for (method of paymentMethods; track method.type) {
              <mat-radio-button
                [value]="method.type"
                class="payment-option"
                (change)="onPaymentMethodChange(method.type)">
                <div class="payment-option-content">
                  <mat-icon>
                    @switch (method.type) {
                      @case ('CreditCard') { credit_card }
                      @case ('DebitCard') { credit_card }
                      @case ('PayPal') { account_balance_wallet }
                      @case ('BankTransfer') { account_balance }
                      @case ('CashOnDelivery') { local_shipping }
                    }
                  </mat-icon>
                  <span>{{ method.label }}</span>
                </div>
              </mat-radio-button>
            }
          </mat-radio-group>

          @if (paymentFormGroup.get('paymentMethod')?.value === 'CreditCard' ||
               paymentFormGroup.get('paymentMethod')?.value === 'DebitCard') {
            <div class="card-details">
              <h3>Card Details</h3>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Cardholder Name</mat-label>
                <input matInput formControlName="cardName" required>
                <mat-icon matPrefix>person</mat-icon>
                <mat-error>Cardholder name is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Card Number</mat-label>
                <input matInput formControlName="cardNumber" maxlength="19" required>
                <mat-icon matPrefix>credit_card</mat-icon>
                <mat-error>Card number is required</mat-error>
              </mat-form-field>

              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Expiry Date (MM/YY)</mat-label>
                  <input matInput formControlName="cardExpiry" placeholder="12/25" maxlength="5" required>
                  <mat-error>Expiry date is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>CVV</mat-label>
                  <input matInput type="password" formControlName="cardCvv" maxlength="4" required>
                  <mat-icon matPrefix>lock</mat-icon>
                  <mat-error>CVV is required</mat-error>
                </mat-form-field>
              </div>
            </div>
          }

          @if (paymentFormGroup.get('paymentMethod')?.value === 'PayPal') {
            <div class="payment-info">
              <mat-icon>info</mat-icon>
              <p>You will be redirected to PayPal to complete your payment.</p>
            </div>
          }

          @if (paymentFormGroup.get('paymentMethod')?.value === 'BankTransfer') {
            <div class="payment-info">
              <mat-icon>info</mat-icon>
              <p>Bank transfer details will be provided after order confirmation.</p>
            </div>
          }

          @if (paymentFormGroup.get('paymentMethod')?.value === 'CashOnDelivery') {
            <div class="payment-info">
              <mat-icon>info</mat-icon>
              <p>Pay with cash when your order is delivered.</p>
            </div>
          }

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button mat-raised-button color="primary" matStepperNext>
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Review & Place Order -->
      <mat-step label="Review">
        <div class="review-section">
          <h2>Order Summary</h2>

          <mat-card class="review-card">
            <h3>Shipping Information</h3>
            <p><strong>Name:</strong> {{ shippingFormGroup.get('firstName')?.value }} {{ shippingFormGroup.get('lastName')?.value }}</p>
            <p><strong>Email:</strong> {{ shippingFormGroup.get('email')?.value }}</p>
            @if (shippingFormGroup.get('phone')?.value) {
              <p><strong>Phone:</strong> {{ shippingFormGroup.get('phone')?.value }}</p>
            }
            <p><strong>Address:</strong>
              {{ shippingFormGroup.get('shippingStreet')?.value }},
              {{ shippingFormGroup.get('shippingCity')?.value }},
              {{ shippingFormGroup.get('shippingState')?.value }}
              {{ shippingFormGroup.get('shippingZipCode')?.value }},
              {{ shippingFormGroup.get('shippingCountry')?.value }}
            </p>
          </mat-card>

          <mat-card class="review-card">
            <h3>Payment Method</h3>
            <p>{{ selectedPaymentMethod().label }}</p>
          </mat-card>

          <mat-card class="review-card">
            <h3>Order Items ({{ basketItems.length }})</h3>
            <div class="review-items">
              @for (item of basketItems; track item.catalogItemId) {
                <div class="review-item">
                  <img [src]="getImageUrl(item.pictureUrl)" [alt]="item.productName">
                  <div class="item-info">
                    <h4>{{ item.productName }}</h4>
                    <p>Quantity: {{ item.quantity }}</p>
                  </div>
                  <div class="item-price">
                    {{ (item.unitPrice * item.quantity) | number:'1.0-0' }} FCFA
                  </div>
                </div>
              }
            </div>

            <mat-divider></mat-divider>

            <div class="order-totals">
              <div class="total-row">
                <span>Subtotal:</span>
                <span>{{ subtotal | number:'1.0-0' }} FCFA</span>
              </div>
              <div class="total-row">
                <span>Shipping:</span>
                <span>
                  @if (shipping === 0) {
                    <span class="free">FREE</span>
                  } @else {
                    {{ shipping | number:'1.0-0' }} FCFA
                  }
                </span>
              </div>
              <div class="total-row">
                <span>Tax (10%):</span>
                <span>{{ tax | number:'1.0-0' }} FCFA</span>
              </div>
              <div class="total-row grand-total">
                <span>Total:</span>
                <span>{{ total | number:'1.0-0' }} FCFA</span>
              </div>
            </div>
          </mat-card>

          <div class="step-actions">
            <button mat-button matStepperPrevious [disabled]="submitting()">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="placeOrder()"
              [disabled]="submitting()">
              @if (submitting()) {
                <ng-container>
                  <mat-spinner diameter="20"></mat-spinner>
                  <span>Processing...</span>
                </ng-container>
              } @else {
                <ng-container>
                  <mat-icon>shopping_cart_checkout</mat-icon>
                  <span>Place Order</span>
                </ng-container>
              }
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  }
</div>
